<#assign base="${request.contextPath}" />
<!DOCTYPE html>
<html>   
    <head>       
        <meta http-equiv="Expires" content="0">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="Cache-Control" content="no-store">
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>极源WIFI</title>
        <link type="text/css" href="${base}/resource/shop/css/shop-item.css" rel="stylesheet">

        <script type="text/javascript" language="javascript" src="${base}/resource/script/jquery/jquery-1.8.3.min.js"></script>

        <link type="text/css" href="${base}/resource/script/bootstrap/css/bootstrap.min.css" rel="stylesheet" >
        <script type="text/javascript" language="javascript" src="${base}/resource/script/bootstrap/bootstrap.min.3.2.0.js"></script> 

        <link type="text/css" media="all" href="${base}/resource/script/bootstrap-daterangepicker-master/daterangepicker-bs3.css" rel="stylesheet"/>
        <script type="text/javascript" src="${base}/resource/script/bootstrap-daterangepicker-master/moment.js"></script>
        <script type="text/javascript" src="${base}/resource/script/bootstrap-daterangepicker-master/daterangepicker.js"></script>  

        <link rel="stylesheet" href="${base}/resource/script/paging/pagination.css" />      
        <script type="text/javascript" src="${base}/resource/script/paging/jquery.pagination.js"></script>

        <script type="text/javascript" src="${base}/resource/shop/script/jeekly.tools.js"></script>        
        <script type="text/javascript">

            function initLeftMenu() {
                $(".list-group-item").click(function() {
                    $(this).parent().children("a").removeClass();
                    $(this).parent().children("a").addClass("list-group-item");
                    $(this).addClass("list-group-item active");
                });
                $(".list-group-item").hover(
                        function() {
                            $(this).stop().animate({paddingLeft: "40px"}, 200);
                        },
                        function() {
                            $(this).stop().animate({paddingLeft: "15px"});
                        }
                );
            }
            //var LocVariable = {"sid": "", "pageindex": 1, "pagesize": 1, "pagecontent": []};
            function getSreachFilters(pageindex, pagesize) {
                var FiltersList = {};
                var dt = $('input[name="dt"]').val().length > 0 ? $('input[name="dt"]').val() : new Date().Format("yyyy-MM-dd", 0) + ' To ' + new Date().Format("yyyy-MM-dd", 1);
                var ct = $('select[name="ct"] option:selected').val();
                var F_EQS_U = $('input[name="uname"]').val();
                var category = $('.selectedCategory').val();
                $.extend(FiltersList, {'dt': dt, 'ct': ct, 'grid': category, "pageindex": pageindex, "pagesize": pagesize});
                if (F_EQS_U.length > 0)
                    $.extend(FiltersList, {'filter_EQS_wifiuser.name': F_EQS_U});
                return FiltersList;
            }
            function Sreach(page_index) {
                //console.log(page_index);
                var JY = $.jeekly;
                JY.box('show', {'msg': '努力加载中...', 'showbg': 1});
                var wifiuser_list = JY.getJsonData('getlist', getSreachFilters(page_index, 10)); //在这里定义每页多少记录 默认10条
                JY.box('hide');
                if (typeof (wifiuser_list) === 'string') {
                    JY.box('show', {'msg': '出错了!<br>重新登录并尝试!<br>或请联系管理员 18691525183', 'showbg': 1});
                    wifiuser_list = [];
                }
                if (wifiuser_list.PageContent.length > 0) {
                    $("#Pagination").pagination(wifiuser_list.totalElements, {items_per_page: 5, num_display_entries: 10, num_edge_entries: 2, link_to: "#", prev_text: "上一页", next_text: "下一页", ellipse_text: "...",
                        current_page: wifiuser_list.pageNumber - 1,
                        callback: pageselectCallback,
                        anydata: wifiuser_list.PageContent});
                } else {
                    JY.box('show', {'msg': ' 这段时间没有数据!', 'showbg': 1, 'showtime': 5});
                    $('#um').children('tbody').children().remove();
                }
            }
            function pageselectCallback(pagenumber, jq, opts) {
                //console.log(pagenumber,opts.current_page);
                if (pagenumber !== opts.current_page)
                    Sreach(pagenumber + 1);
                setDataToTable($('#um'), opts.anydata);
            }
            function setDataToTable(tb, data) {
                var t = tb.children('tbody').children().remove();
                var tbHeadTr = tb.children('thead').find('tr');
                for (var i = 0; i < data.length; i++) {
                    var row = tbHeadTr.clone().removeAttr("class");
                    row.find("#choose").html("<input type=checkbox  name='ids' value='" + data[i].user.id + "'/>");
                    row.find("#no").text(i + 1);
                    row.find("#lv").text(data[i].maxdt);
                    row.find("#uname").text(data[i].user.name);
                    row.find("#times").text(data[i].count);
                    row.find("#fv").text(data[i].mindt);
                    row.find("#operating").text("");
                    row.appendTo(tb.children('tbody'));
                }
                return tb;
            }
            function tagEl(arg) {
                //console.log(id);
                $(arg).parent().children().removeAttr("style").removeClass("selectedCategory");
                $(arg).addClass("selectedCategory").css({'background-color': 'blue', 'opacity': '0.3'});
                Sreach(1);
            }
            function saveToCategory() {
                var s = $('select[name="gr"] option:selected').val() || "";
                var idsArr = [];
                $('input[name="ids"]:checked').each(function() {
                    idsArr.push($(this).val());
                });
                if (s.length === 0 || idsArr.length === 0) {
                    $('.categoryAlert').html("请选择用户/分类").fadeIn(1000).fadeOut(2000);
                }
                else {
                    //console.log("s:" + s); console.log("i:" + idsArr);
                    $.ajax({url: 'tocategory', traditional: true, data: {"grid": s, "ids": idsArr},
                        success: function(v) {
                            //console.log(v);
                            $('#showcategory-modal').modal('hide');
                            $('.category-opt-msg').html("用户分组操作成功").fadeIn(1000).fadeOut(5000);
                            tagEl("#" + s);
                        }});
                }
            }
            function delWifiusers() {
                var category = $('.selectedCategory').val() || "";
                var idsArr = [];
                $('input[name="ids"]:checked').each(function() {
                    idsArr.push($(this).val());
                });
                if (idsArr.length === 0) {
                    $('.category-opt-msg').html("请选择要删除的用户").fadeIn(1000).fadeOut(5000);
                } else {
                    //console.log(idsArr);
                    $.ajax({url: 'deluserslog', traditional: true, data: {"grid": category, "ids": idsArr},
                        success: function(v) {
                            $('.category-opt-msg').html("用户删除操作成功").fadeIn(1000).fadeOut(5000);
                            Sreach(1);
                        }});
                }

            }
            $(function() {
                initLeftMenu();
                $('input[name="dt"]').daterangepicker({showDropdowns: true, showWeekNumbers: true, format: 'YYYY-MM-DD', minDate: '2014-01-01', separator: ' To ',
                    locale: {applyLabel: '确认', cancelLabel: '取消', fromLabel: 'From', toLabel: 'To', customRangeLabel: 'Custom',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                        monthNames: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        firstDay: 1}});
                $('input[name="selectAll"]').click(function() {
                    var checkbox = $(this);
                    var children = $('#um').children('tbody').children().find("input[type='checkbox']");
                    children.prop("checked", checkbox.is(":checked"));
                });
                $('#showcategory-modal').css({
                    'margin-top': function() {
                        return ($('.right_el').height() / 2);
                    },
                    'margin-left': function() {
                        return ($('.right_el').width() / 2);
                    }});
                Sreach(1);
            });
        </script>
    </head>
    <body>
        <!--modal -->
        <div class="modal fade" id="showcategory-modal" data-backdrop='false' role="dialog" aria-hidden="true" style="overflow-y:auto;">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header" style=" padding: 10px; border-top-left-radius: 3px;border-top-right-radius: 3px;">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title"><span class="glyphicon glyphicon-search"></span> 选择分类</h4>
                    </div>
                    <div class="modal-body">
                        <select name="gr" class="form-control"> 
                            <option value="">请选择...</option>
                            <#list groupsList as gr>
                            <option value='${gr.id}'>${gr.name}</option>
                            </#list>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <span class='categoryAlert alert alert-warning' style="display: none;padding: 6px 1px 6px 1px;">请选择用户/分类</span>
                        <div class="btn-group">                               
                            <button type="button" class="btn btn-info"  data-dismiss="modal" aria-hidden="true">
                                <span class="glyphicon glyphicon-remove"></span> 取消
                            </button>
                            <button type="button" name="categorychoosedok" class="btn btn-success" onclick="saveToCategory();">
                                <span class="glyphicon glyphicon-ok"></span> 确定
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>      
        <!--modal -->    

        <!-- Navigation -->
        <#include "top.html" />
        <!-- Page Content -->
        <div class="container">
            <div class="row">
                <#include "left.html" />
                <div class="col-md-9 right_el">
                    <div class="well form-inline" style="margin: 1px auto;padding-left: 7px;">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                            <input type="text" name="dt" class="form-control" placeholder="请选择日期">
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon"> 次数</span>
                            <select name="ct" class="form-control">   
                                <option value="0">全部</option>   
                                <option value="1">1次</option>   
                                <option value="2">2次</option> 
                                <option value="3">3次</option> 	
                                <option value="4">4次</option> 
                                <option value="5">5次以上</option>								
                            </select>
                        </div>  

                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-phone"></i></span>
                            <input type="text" class="form-control" name="uname"  placeholder="请输入账号">
                            <span class="input-group-btn">
                                <button class="btn btn-comit" type="button" onclick="Sreach(1)">Go</button>
                            </span>
                        </div>

                    </div>

                    <div class="panel panel-default "  style=" margin: 0 auto;">
                        <div class="panel-heading"  style="padding:10px 0px 10px 7px;">
                            <div class="btn-toolbar">
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="glyphicon glyphicon-folder-open"></i></span>
                                    <div class="btn-group usergroupbtn">
                                        <button type="button" value="" class="btn btn-default" onclick="tagEl(this);">ALL</button>
                                        <#if groupsList??>
                                        <#list groupsList as gr>
                                        <button type="button" id="${gr.id}" value="${gr.id}" class="btn btn-default" onclick="tagEl(this);">${gr.name!''}</button>
                                        </#list>
                                        </#if>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-body" style="padding-top: 2px;padding-bottom: 0px;height: 30px;">

                            <div class="category-opt-msg alert alert-success text-center" style="display: none;width: 20%;margin: 0 auto; padding: 2px 1px 2px 1px;">
                                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                                <span class="glyphicon glyphicon-ok"></span>用户分组操作成功
                            </div>

                        </div>

                        <table id="um" class="table table-striped table-bordered table-condensed text-center" >
                            <caption></caption>
                            <thead>
                                <tr class="info text-primary ">
                                    <td id="choose" style="width: 40px">选择</td>
                                    <td id="no">序号</td>
                                    <td id="lv">最后访问时间 </td>
                                    <td id="uname">会员账号</td>
                                    <td id="times">来店次数</td>
                                    <td id="fv">注册时间</td>
                                    <td id="operating">操作</td>
                                </tr>
                            </thead>
                            <tbody>       
                                <tr>
                                    <td><input type="checkbox"  value="" /></td>
                                    <td>12</td>
                                    <td>22</td>
                                    <td>1321</td>
                                    <td>12</td>
                                    <td>12</td>

                                    <td>12</td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" value="" /></td>
                                    <td>12</td>
                                    <td>22</td>
                                    <td>1321</td>
                                    <td>12</td>
                                    <td>12</td>

                                    <td>12</td>
                                </tr>
                            </tbody> 
                        </table>
                    </div>
                    <div class="btn-toolbar" style="margin-top: 5px ;">
                        <div class="btn-group"  style="padding:1px 1px 1px 2px;" >
                            <span class="btn btn-comit btn-sm"><input type="checkbox" name="selectAll" /></span>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-comit" data-toggle="modal" data-target="#showcategory-modal">会员归类</button>

                        </div>
                        <div class="btn-group">                         
                            <button type="button" class="btn btn-comit" onclick="delWifiusers();">批量删除</button>
                        </div>
                    </div>
                    <div class="text-center">
                        <div id="Pagination" class="pagination"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- /.container -->
        <#include "foot.html" />
        <!-- /.container -->
    </body>
</html>
